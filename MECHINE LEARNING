#ML Flow Setup
pdf = spark.sql("""
    SELECT
        year,
        month,
        region,
        category,
        product_name,
        quantity
    FROM codebasics_project_1.silver.silver_ecommerce_orders
""").toPandas()
pdf.head()

X = pdf[[
    "year",
    "month",
    "region",
    "category",
    "product_name"
]]

y = pdf["quantity"]

from sklearn.preprocessing import OneHotEncoder
from sklearn.compose import ColumnTransformer

categorical_cols = ["region", "category", "product_name"]
numeric_cols = ["year", "month"]

preprocessor = ColumnTransformer(
    transformers=[
        ("cat", OneHotEncoder(handle_unknown="ignore"), categorical_cols),
        ("num", "passthrough", numeric_cols)
    ]
)

X_processed = preprocessor.fit_transform(X)

split_index = int(len(pdf) * 0.8)

X_train = X_processed[:split_index]
X_test  = X_processed[split_index:]

y_train = y.iloc[:split_index]
y_test  = y.iloc[split_index:]

from sklearn.ensemble import RandomForestRegressor

model = RandomForestRegressor(
    n_estimators=100,
    random_state=42
)

model.fit(X_train, y_train)

import mlflow
import mlflow.sklearn
from sklearn.metrics import mean_squared_error
import numpy as np

mlflow.autolog()

with mlflow.start_run(run_name="Demand_Forecast_With_Dimensions"):
    model.fit(X_train, y_train)
    
    preds = model.predict(X_test)
    rmse = np.sqrt(mean_squared_error(y_test, preds))
    
    mlflow.log_metric("rmse", rmse)

    #Testing

    import pandas as pd
import itertools

years = [2025]
months = list(range(1, 13))
regions = ["East", "West", "North"]
categories = ["Office", "Accessories", "Electronics"]
products = ["Printer", "Mouse", "Tablet", "Camera", "Headphones", "Smartwatch", "Monitor"]

# Create all combinations
future_rows = list(itertools.product(
    years, months, regions, categories, products
))

future_2025 = pd.DataFrame(
    future_rows,
    columns=["year", "month", "region", "category", "product_name"]
)

future_2025.head()

import calendar

# Choose what you want to show
selected_year = 2025
selected_month = 3   # March
selected_region = "East"

final_prediction_view = future_2025[
    (future_2025["year"] == selected_year) &
    (future_2025["month"] == selected_month) &
    (future_2025["region"] == selected_region)
].copy()

# Add month name for readability
final_prediction_view["month_name"] = final_prediction_view["month"].apply(
    lambda x: calendar.month_name[x]
)

# Round quantity
final_prediction_view["predicted_quantity"] = (
    final_prediction_view["predicted_quantity"]
    .round(0)
    .astype(int)
)

# Select clean columns for presentation
final_prediction_view = final_prediction_view[
    ["year", "month_name", "region", "category", "product_name", "predicted_quantity"]
]


final_prediction_view
